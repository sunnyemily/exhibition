<!DOCTYPE html>
<html class="x-admin-sm" lang="en" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>修改参展商管理-人员证件制作（现场）</title>
		<meta content="webkit" name="renderer">
		<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
		<meta content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" name="viewport"/>
		<link rel="stylesheet" href="/manage/css/xadmin.css">
		<link href="/manage/css/style.css?v=4.1.0" rel="stylesheet">
		<link href="/manage/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
		<link rel="stylesheet" href="/manage/layui/css/layui.css"  media="all">
	</head>
	<body class="gray-bg">
		<div class="modal inmodal" id="friendlink-model">
			<div class="modal-content animated bounceInUp" id="vmUpdateEbsPersonnelcard">
				<div class="ibox-content">
					<fieldset class="layui-elem-field layui-field-title" style="border-top:0px">
						<form class="layui-form layui-form-pane" lay-filter="test1" action="">
							<table width="100%">
								<tr>
									<td colspan="2" style="padding-bottom:10px">
										<table style="width:400px">
											<tr>
												<td height="30px" valign="">										
													<a class="layui-btn" href="PersonnelCardProductionOnSiteManage.html" title="查看已有证件信息">查看已有证件信息</a>										
												</td>
												<td  height="30px" valign="top">	
													<a href="javascript:void(0)" onclick="ReadCard()" class="layui-btn">
														读取身份证
													</a>										
												</td>
												<td>
													<a href="http://127.0.0.1:19196/mainpage" target="_blank">链接读卡器</a>
												</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr>
									
								</tr>
								<tr>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="cardnumber" style="width:130px"><span style='color:red'>*</span>证件类型</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<select id="cardtype" lay-filter="cardtype" name="cardtype" lay-verify="required">

												</select>
											</div>
										</div>
									</div></td>
									<td></td>
								</tr>
								<tr>
									<td width="50%">
									<div class="layui-form-item">
										<label class="layui-form-label" for="companyname" style="width:130px"><span style='color:red'>*</span>企业名称</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<input class="layui-input" autocomplete="off" lay-verify="required" id="companyname" name="companyname" type="text">
												<input type="hidden" id="companyid" name="companyid" >
											</div>
										</div>
									</div></td>
									<td></td>
								</tr>
								<tr>
									<td colspan="2">
									<div class="layui-form-item">
										<label class="layui-form-label" for="name" style="width:130px"><span style='color:red'>*</span>国家</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<table width="80%">
													<tr>
														<td><select id="country" lay-verify="required" lay-filter="country" name="country"></select></td>
														<td><select id="province" lay-verify="required" lay-filter="province" name="province"></select></td>
														<td><select id="city" name="city"></select></td>
													</tr>
												</table>
											</div>
										</div>
									</div></td>
								</tr>
								<tr>
									<td width="50%">
									<div class="layui-form-item">
										<label class="layui-form-label" for="name" style="width:130px"><span style='color:red'>*</span>姓名</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<input class="layui-input" lay-verify="required" autocomplete="off" id="name" name="name" type="text">
											</div>
										</div>
									</div></td>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="sex" style="width:130px">性别</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block radioborder" style="width:80%">
												<input type="radio" value="0" id="sex1" checked title="男" name="sex">
												<input type="radio" value="1" name="sex" id="sex2" title="女">
											</div>
										</div>
									</div></td>
								</tr>
								<tr>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="idcardpassport" style="width:130px">手机号</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<input autocomplete="off" class="layui-input" id="phone" name="phone" type="text">
											</div>
										</div>
									</div></td>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="idcardpassport" style="width:130px">地址</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<input autocomplete="off" class="layui-input" id="address" name="address" type="text">
											</div>
										</div>
									</div></td>
								</tr>
								<tr>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="idcardpassport" style="width:130px"><span style='color:red'>*</span>身份证件类型</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block radioborder" style="width:80%">
												<input type="radio" lay-filter="idcardpassport" value="0" checked id="idcardpassport1" title="身份证" name="idcardpassport">
												<input type="radio" lay-filter="idcardpassport" value="1" name="idcardpassport" id="idcardpassport2" title="护照">
												<input type="radio" lay-filter="idcardpassport" value="2" name="idcardpassport" id="idcardpassport3" title="记者证">
											</div>
										</div>
									</div></td>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="cardnumber" style="width:130px"><span style='color:red'>*</span>证件编号</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<input class="layui-input" autocomplete="off" lay-verify="required" id="cardnumber" name="cardnumber" type="text">
											</div>
										</div>
									</div></td>
								</tr>

								<tr>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="idcardpassport" title="签发机关+有效期限" style="width:160px">签发机关+有效期限</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<input autocomplete="off" class="layui-input" id="issuevalid" name="issuevalid" type="text">
											</div>
										</div>
									</div></td>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="idcardpassport" style="width:130px">展位</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
												<input placeholder="证件为参展证、布撤展证时必填,格式:A1001,A2003 B2001-B2010" autocomplete="off" class="layui-input" id="boothcode" name="boothcode" type="text">

											</div>
										</div>
									</div></td>
								</tr>

								<tr class="trFlag">
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="jobtitle" style="width:130px"><span style='color:red'>*</span>业务领域</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:90%">
												<select id="yewulingyu" name="yewulingyu">

												</select>
											</div>
										</div>
									</div></td>
									<td>
									<div class="layui-form-item">
										<label class="layui-form-label" for="jobtitle" style="width:130px"><span style='color:red'>*</span>参会角色</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:90%">
												<select id="canhuijuese" name="canhuijuese">

												</select>
											</div>
										</div>
									</div></td>
								</tr>
								<tr class="trFlag">
									<td colspan="2">
									<div class="layui-form-item">
										<label class="layui-form-label" for="companyname" style="width:130px"><span style='color:red'>*</span>参会目的</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block radioborder" id="canhuimudi" style="width:96%">

											</div>
										</div>
									</div></td>
								</tr>
								<tr class="trFlag">
									<td colspan="2">
									<div class="layui-form-item">
										<label class="layui-form-label" for="companyname" style="width:160px"><span style='color:red'>*</span>您想参观的展区</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="width:94%">
												<select id="xcgdzq" name="xcgdzq">

												</select>
											</div>
										</div>
									</div></td>
								</tr>
								<tr class="trFlag">
									<td colspan="2">
									<div class="layui-form-item">
										<label class="layui-form-label" for="companyname" style="width:160px"><span style='color:red'>*</span>您如何知道展会</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" id="ruhezhidaozhanhui"  style="width:94%;height:80px;border-left:1px solid #e8e8e8;border-bottom:1px solid #e8e8e8;border-right:1px solid #e8e8e8;border-top:1px solid #e8e8e8;border-radius: 0 2px 2px 0;">

											</div>
										</div>
									</div></td>
								</tr>
								<tr class="trFlag">
									<td colspan="2">
									<div class="layui-form-item">
										<label class="layui-form-label" for="companyname" style="width:130px">业务性质</label>
										<div class="layui-input-block">
											<div class="layui-input-inline layui-show-xs-block" style="height:80px;border-left:1px solid #e8e8e8;border-bottom:1px solid #e8e8e8;border-right:1px solid #e8e8e8;border-top:1px solid #e8e8e8;border-radius: 0 2px 2px 0;" id="yewuxingzhi">

											</div>
										</div>
									</div></td>
								</tr>
								<tr id="trcgyx" style="display:none">
									<td colspan="2">
										<div class="layui-form-item">
											<label class="layui-form-label" style="height: 100px;line-height: 70px;"><span style='color:red'>*</span>采购意向</label>
											<div class="layui-input-block">
												<div class="layui-input-inline layui-show-xs-block">
													<textarea class="layui-textarea" id="purchasingintention" name="purchasingintention"  v-model="ebsPersonnelcard.purchasingintention" rows="4"></textarea>										
													<span style="color: red;">采购意向要求大于20字</span>										
												</div>
											</div>
										</div>
									</td>
								</tr>
								<tr>
									<td valign="top" style="padding:0px">
										<div class="layui-form-item">										
											<label class="layui-form-label" for="companyname" style="width:130px"><span style='color:red'>*</span>证件照片</label>
												<div class="layui-input-inline layui-show-xs-block" style="width:80%">
													<input class="layui-input" autocomplete="off" id="imagepath" name="imagepath" type="hidden">
													<button type="button" class="layui-btn" id="btnImagePath">
													  <i class="layui-icon">&#xe67c;</i>裁剪助手
													</button>
									                <br>
									                <span style="color:red;font-size:16px">格式为jpg，上传文件小于2M。标准证件照尺寸600*749（宽*高）像素，证件照背景为红、白、蓝。</span>
												</div>
											
										</div>
									</td>
									<td style="padding:5px">
										<img src="/images/1.jpg" onclick="SeeImage(this.src)" width="195" id="preimagepath" height="243">
									</td>
								</tr>
								<tr>
									<td valign="top">
									<div class="layui-form-item">
										<label class="layui-form-label" for="companyname" style="width:140px"><span style='color:red'>*</span><span id="spleixing">身份证（护照）</span></label>
											<div class="layui-input-inline layui-show-xs-block" style="width:80%">
													<input class="layui-input" autocomplete="off" id="idphotopath" name="idphotopath" type="hidden">
													<button type="button" class="layui-btn" onclick="uploadzjzp(693,472)" id="btnIdPhotoPath">
													  <i class="layui-icon">&#xe67c;</i>裁剪助手
													</button>
									                <br>
									                <span style="color:red;font-size:16px" id="sptext">格式为jpg，上传文件小于2M。身份证尺寸693*472（宽*高）像素。</span>
												</div>
										
									</div></td>
									<td style="padding:5px">
										<img src="/images/2.jpg" onclick="SeeImage(this.src)" width="195" height="132" id="preidphotopath">
									</td>
								</tr>
								<tr id="tryyzz" style="display:none">
									<td valign="top" style="padding:0px">
									<div class="layui-form-item">
										<label class="layui-form-label" for="companyname" style="width:140px"><span style='color:red'>*</span>营业执照</label>
										<div class="layui-input-inline layui-show-xs-block" style="width:80%">
											<input class="layui-input" autocomplete="off" id="businesslicense" name="businesslicense" type="hidden" v-model="ebsPersonnelcard.businesslicense">
											<button type="button" class="layui-btn" id="btnbusinesslicense">
												<i class="layui-icon">&#xe67c;</i>裁剪助手
											</button>
											<br>
											<span style="color:red;font-size:16px">格式为jpg，上传文件小于2M。营业执照尺寸为800*1060（宽*高）像素</span>
										</div>

									</div></td>
									<td style="padding:5px"><img onclick="SeeImage(this.src)" src="/images/4.jpg" width="195" id="prebusinesslicense" height="258"></td>
								</tr>
							</table>
							<div class="layui-form-item">
								<div class="layui-input-block">
									<button class="layui-btn" lay-filter="edit" lay-submit="">
										确认添加
									</button>
									<input type="hidden" id="txtcardleixing">
								</div>
							</div>
						</form>
					</fieldset>
				</div>
			</div>
		</div>
		<script charset="utf-8" src="/manage/js/jquery.min.js" type="text/javascript"></script>
		<script charset="utf-8" src="/manage/layui/layui.js" type="text/javascript"></script>
		<script charset="utf-8" src="/manage/js/xadmin.js" type="text/javascript"></script>
		<script src="/manage/js/bootstrap.min.js?v=3.3.6"></script>
		<script src="/manage/js/manage/common.js"></script>
		<script src="/script/validate.js?v=3.3.6"></script>	
		<script charset="UTF-8" type="text/javascript">
			function ReadCard(){
				$.get('http://127.0.0.1:19196/readcard',function(res){
					var json = eval('(' + res + ')');
					//console.log(json);
					$("#address").val(json.certAddress);
					$("#cardnumber").val(json.certNumber);
					$("#name").val(json.partyName);
					$("#issuevalid").val(json.certOrg+"  "+json.effDate+"~"+json.expDate);
					var gender = json.gender=='男' ? 0 : 1;
					
					var radio = document.getElementsByName("sex");
					var radioLength = radio.length;
					for (var i = 0; i < radioLength; i++) {
						//console.log(radio[i].value);
						if (gender == radio[i].value) {
							$(radio[i]).next().click();
						}
					}
					
				});
			}
			
			
			
			layui.use(['form', 'layer', 'laydate'], function() {
				var form = layui.form, layer = layui.layer, laydate = layui.laydate;
				loadZiDianByParentID_Select(form, '', 3, "canhuijuese");
				loadZiDianByParentID_Select(form, '', 20, "xcgdzq");
				loadIndustry(form, '', "yewulingyu");
				loadZiDianByParentID_Checkbox(form, '', 4, "canhuimudi");
				loadZiDianByParentID_Checkbox(form, '', 6, "ruhezhidaozhanhui");
				loadZiDianByParentID_Checkbox(form, '', 8, "yewuxingzhi");
				loadCountry(form, $("#txtcountry").val(), $("#txtarea").val(), $("#txtcity").val(), "country", "province", "city");
				loadCardType(form, 'cardtype', 0, 0, '');

				form.render(null, 'test1');
				
				form.on('select(cardtype)', function(data) {					
					var cardtypename = data.elem[data.elem.selectedIndex].text;
					if(cardtypename=='采购商证'){
						$("#trcgyx").show();
						$("#tryyzz").show();
					}
					else{
						$("#trcgyx").hide();
						$("#tryyzz").hide();
					}
					$("#txtcardleixing").val(cardtypename);
				});
				
				form.on('radio(idcardpassport)', function(data) {					
					if (data.value == 2) {//记者证
						$("#spleixing").html("新闻记者证");
						$("#sptext").html("格式为jpg，上传文件小于2M，尺寸606*436（宽*高）像素。");
						$("#btnIdPhotoPath").attr("onclick", "uploadzjzp(606,436)");
					} else {
						$("#spleixing").html("身份证/护照");
						$("#sptext").html("格式为jpg，上传文件小于2M，身份证尺寸693*472（宽*高）像素。");
						$("#btnIdPhotoPath").attr("onclick", "uploadzjzp(693,472)");
					}
				});

				form.on('select(country)', function(data) {
					loadProvinceChange(form, $("#country").val(), '', "province");
					form.render(null, 'test1');
				});
				form.on('select(province)', function(data) {
					loadCity(form, $("#province").val(), '', "city");
					form.render(null, 'test1');
				});
				//监听提交
				form.on('submit(edit)', function(data) {
					
					var zjlx = $('input:radio[name="idcardpassport"]:checked').val();
	            	if(zjlx==0){
	            		console.log(checkID(data.field.cardnumber));
	            		if(!checkID(data.field.cardnumber)){
	            			layer.msg("请输入正确的身份证号", {icon: 2, time: 1000},function(){$("#cardnumber")[0].focus();});
	            			return false;
	            		}
	            	}		
					
					if ($("#imagepath").val() == '' || $("#idphotopath").val() == '') {
						layer.msg("请上传人员证件", {
							icon : 2,
							time : 1000
						});
						return false;
					}
					//组装数据

					var canhuimudi = "";
					var ruhezhidaozhanhui = "";
					var yewuxingzhi = "";
					$('input[name=chkcanhuimudi]:checked').each(function() {
						canhuimudi += $(this).val() + ",";
					});
					console.log(canhuimudi);
					$('input[name=chkruhezhidaozhanhui]:checked').each(function() {
						ruhezhidaozhanhui += $(this).val() + ",";
					});
					$('input[name=chkyewuxingzhi]:checked').each(function() {
						yewuxingzhi += $(this).val() + ",";
					});
					canhuimudi = canhuimudi.length > 0 ? canhuimudi.substring(0, canhuimudi.length - 1) : "";
					ruhezhidaozhanhui = ruhezhidaozhanhui.length > 0 ? ruhezhidaozhanhui.substring(0, ruhezhidaozhanhui.length - 1) : "";
					yewuxingzhi = yewuxingzhi.length > 0 ? yewuxingzhi.substring(0, yewuxingzhi.length - 1) : "";
					data.field.purpose = canhuimudi;
					data.field.knowexhibition = ruhezhidaozhanhui;
					data.field.businessnature = yewuxingzhi;
					data.field.visitexhibition = $("#xcgdzq").val();
					data.field.participants = $("#canhuijuese").val();
					data.field.bussinessarea = $("#yewulingyu").val();
					
					if(canhuimudi==''){
	                	layer.msg("请选择参会目的", {icon: 2, time: 1000});
	                	return false;
	                }
				    if(ruhezhidaozhanhui==''){
	                	layer.msg("请选择您如何知道展会", {icon: 2, time: 1000});
	                	return false;
	                }
	                
	                if($("#txtcardleixing").val()=='采购商证'){	                
						var cgyx = $("#purchasingintention").val(); 
		                if(cgyx==''){
		                	layer.msg("请填写采购意向", {icon: 2, time: 1000});	                	
		                	return false;
		                }
		                if(cgyx.length<20){
		                	layer.msg("采购意向要求大于20字", {icon: 2, time: 1000});
		                	return false;
		                }
		                if ($("#businesslicense").val() == '') {
							layer.msg("请上传营业执照", {
								icon : 2,
								time : 1000
							});
							return false;
						}
		           	}
					if($("#txtcardleixing").val()=='布撤展证'){
						if($("#boothcode").val() == ''){
							layer.msg("请填写展位号", {
								icon : 2,
								time : 1000
							});
							return false;
						}
					}
					data.field.agent = parent.user.id;
					data.field.cardnature = 1;
					data.field.status=1;
					//现场
					//发异步，把数据提交给controller
					$.ajax({
						url : "/manage/Exhibitors/ebsPersonnelcard/PersonnelCardProductionOnSitesave",
						data : JSON.stringify(data.field),
						dataType : "json",
						contentType : "application/json",
						type : "post",
						success : function(result) {
							if (result.code === 1) {
								layer.msg("添加成功", {
									icon : 6,
									time : 500
								}, function() {
									location.href = 'PersonnelCardProductionOnSiteAdd.html';
								});
							} else {
								layer.alert(result.msg);
							}
						}
					});
					return false;
				});
			});
		</script>
		<script src="/manage/js/manage/crop.js"></script>
	</body>
</html>