<!DOCTYPE html>
<html class="x-admin-sm" lang="en" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>人员证件制作</title>
		<meta content="webkit" name="renderer">
		<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
		<meta content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" name="viewport"/>
		<link rel="stylesheet" href="/manage/css/xadmin.css">
		<link rel="stylesheet" href="/manage/css/font.css">
		<link href="/manage/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
		<link href="/manage/css/font-awesome.css?v=4.4.0" rel="stylesheet">
		<link href="/manage/css/animate.css" rel="stylesheet">
		<link href="/manage/css/style.css?v=4.1.0" rel="stylesheet">
		<link href="/manage/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
		<script charset="utf-8" src="/manage/js/jquery.min.js" type="text/javascript"></script>
		<script charset="utf-8" src="/manage/layui/layui.js" type="text/javascript"></script>
		<script charset="utf-8" src="/manage/js/xadmin.js" type="text/javascript"></script>
		<script charset="utf-8" src="/manage/js/vue.js" type="text/javascript"></script>
		<style>
			.searchStyle td {
				padding: 0px 2px
			}
		
        .layui-table-cell {
            height: auto;
            line-height: 40px;
        }
    </style>
	</head>
	<body>
		<div class="wrapper wrapper-content  animated fadeInRight">
			<div class="row" id="vmEbsPersonnelcard">
				<div class="col-sm-12">
					<div class="ibox float-e-margins">
						<div class="ibox-title">
							<h5>人员证件制作</h5>
							<div class="ibox-tools">
								<a class="collapse-link"> <i class="fa fa-chevron-up"></i> </a><a class="close-link"> <i class="fa fa-times"></i> </a>
							</div>
						</div>
						<input type="hidden" id="txtsearchtype">
						<div class="ibox-content">
							<div class="fixed-table-toolbar" style="height:120px;">
								<div class="bars pull-left">
									<div class="btn-group hidden-xs" id="exampleTableEventsToolbar" role="group">
										
									</div>
								</div>
								<table style="float:" border=0>
									<tr>
										<td colspan="5">
										<table>
											<tr>
												<td height="40px"><b>证件类型：</b></td>
												<td id="tdcardtype">
												
												</td>
												<td>
												<table style="width:100%">
													<tr>
														<td style="padding-left:5px">
														<select id="agent" onchange="ChuLiSelect('agent')" class="form-control input-outline xlselect" style="min-width:160px">
															<option value="">==代办员==</option>
														</select></td>
													</tr>
												</table>
											</td>
											</tr>
										</table>
										</td>
										
									</tr>
									<tr>
										<td style="padding-right:3px">
										<table style="width:100%">
											<tr>
												<td>
												<select id="jiabinB" onchange="ChuLiSelect('jiabinB')" class="form-control input-outline xlselect" style="width:100%">
													<option value="">==嘉宾B==</option>
												</select></td>
											</tr>
										</table></td>
										<td style="padding-right:3px">
										<table style="width:100%">
											<tr>
												<td>
												<select id="buchezhan" onchange="ChuLiSelect('buchezhan')" class="form-control input-outline xlselect" style="min-width:160px">
													<option value="">==布撤展==</option>
												</select></td>
											</tr>
										</table></td>
										<td style="padding-right:3px">
										<table style="width:100%">
											<tr>
												<td>
												<select id="caigoushang" onchange="ChuLiSelect('caigoushang')" class="form-control input-outline xlselect" style="min-width:160px">
													<option value="">==采购商==</option>
												</select></td>
											</tr>
										</table></td>
										<td style="padding-right:3px">
										<table style="width:100%">
											<tr>
												<td>
												<select id="canzhanzhengB" onchange="ChuLiSelect('canzhanzhengB')" class="form-control input-outline xlselect" style="min-width:160px">
													<option value="">==参展证B==</option>
												</select></td>
											</tr>
										</table></td>
										
										<td></td>
									</tr>
									<tr>

										<td>
										<table>
											<tr>
												<td><b>打印状态：</b></td>
												<td style="padding-right:5px">
												<input type="radio" name="printstatus" class="printstatus" value="0" checked title="未打印">
												未打印
												<input type="radio" name="printstatus" class="printstatus" value="1" title="打印中">
												打印中
												<input type="radio" name="printstatus" class="printstatus" value="2" title="完成打印">
												打印 </td>
											</tr>
										</table></td>
										
										<td>
										<table>
											<tr>
												<td><b>制证性质：</b></td>
												<td style="padding:0px 5px">
												<input type="radio" name="cardnature" class="cardnature" value="" checked title="全部">
												全部
												<input type="radio" name="cardnature" class="cardnature" value="1" title="现场">
												现场
												<input type="radio" name="cardnature" class="cardnature" value="0" title="网络">
												网络 </td>
											</tr>
										</table></td>
										<td>
										<table>
											<tr>
												<td><b>验证状态：</b></td>
												<td style="padding:0px 3px">
												<input type="radio" name="verificationstatus" class="verificationstatus" value="" checked title="全部">
												全部
												<input type="radio" name="verificationstatus" class="verificationstatus" value="0" title="未验证">
												未验证
												<input type="radio" name="verificationstatus" class="verificationstatus" value="1" title="已验证">
												已验证 </td>
											</tr>
										</table></td>
										<td>
										<input name="companyname" autocomplete="off" class="form-control input-outline" type="text" placeholder="请输入公司名称" id="companyname" style="width:160px;">
										</td>
										<td style="padding-right:3px">
										<input name="xingming" autocomplete="off" class="form-control input-outline" type="text" placeholder="请输入姓名" id="xingming" style="width:160px;">
										</td>
										<td style="padding-top:3px">
										<button class="btn btn-default btn-outline" type="button" name="search" title="搜索" onclick="reloadTableData()" id="search">
											<i class="glyphicon glyphicon-search"></i>
										</button>
										<button class="btn btn-default btn-outline" type="button" name="refresh" onclick="location.reload()" title="刷新" id="refresh">
											<i class="glyphicon glyphicon-repeat"></i>
										</button>
										<button class="btn btn-default btn-outline" type="button" name="print" onclick="PrintAll()" title="批量打印" id="print">
											批量打印
										</button>
										</td>
									</tr>
								</table>
							</div>
							<table id="test" lay-filter="test"></table>
							<input type="hidden" id="hidcompanyid">
							<input type="hidden" id="hidcompanyname">
							<input type="hidden" id="txtvalue">
							
						</div>
					</div>
				</div>
			</div>
		</div>
		<input type="hidden" id="txtids">
		<textarea style="display:none" id="txttmep"></textarea>
		<script src="/manage/js/bootstrap.min.js?v=3.3.6"></script>
		<script src="/manage/js/content.js?v=1.0.0"></script>
		<script src="/manage/js/manage/common.js?v=1.0.0"></script>
		<script src="/manage/js/manage/Lodop.js?v=1.0.0"></script>
		<script src="/manage/js/manage/demo.js?v=1.0.0"></script>
	</body>
		<script type="text/html" id="barDemo">
			<!--<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>-->
			{{# if(d.printstatus==0){ }}
			<a class="layui-btn layui-btn-xs" lay-event="print">正常打印</a><br>
			<a class='layui-btn layui-btn-danger layui-btn-xs layui-hide wToy' lay-event='wToy'>未打印=>完成打印</a>
			{{# } }}
			{{# if(d.printstatus==1){ }}
			<a class='layui-btn layui-btn-danger layui-btn-xs layui-hide zTow' lay-event='zTow'>打印中=>未打印</a><br>
			<a class='layui-btn layui-btn-danger layui-btn-xs layui-hide zToy' lay-event='zToy'>打印中=>完成打印</a>
			{{# } }}
			{{# if(d.printstatus==2){ }}			
			<a class="layui-btn layui-btn-danger layui-btn-xs layui-hide huiche" lay-event="backprint">完成打印=>未打印</a>
			{{# } }}
			<!--<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>-->
		</script>
	<script type="text/javascript">
		var userPermissions = loadUserPermissions();
		var table;
		var form;
		layui.use(['form', 'table'], function() {
			table = layui.table;
			var $ = layui.jquery;
			form = layui.form;
			loadCardTypeForRadioForChange(form, 'tdcardtype', 0, 0, '');
			//绑定审核状态
			$(".printstatus").change(function(){reloadpage();});
			$(".verificationstatus").change(function(){reloadpage();});
			$(".cardnature").change(function(){reloadpage();});		
			$(".cardtype").change(function(){reloadpage();});			
			reloadpage();
			function reloadpage(){		
				var verificationstatus = $("input[name='verificationstatus']:checked").val();
				var cardnature = $("input[name='cardnature']:checked").val();			
				var printstatus = $("input[name='printstatus']:checked").val();
				var cardtype = $("input[name='cardtype']:checked").val();
				GetAgentCertificateReviewForChange(form,'agent',2,printstatus,1,verificationstatus,cardnature,'',cardtype);
				GetPendingDocumentsForChange(form,'jiabinB',0,'嘉宾证B',4,printstatus,1,verificationstatus,cardnature,'');
				GetPendingDocumentsForChange(form,'buchezhan',0,'布撤展证',3,printstatus,1,verificationstatus,cardnature,'');
				GetPendingDocumentsForChange(form,'caigoushang',0,'采购商证',5,printstatus,1,verificationstatus,cardnature,'');
				GetPendingDocumentsForChange(form,'canzhanzhengB',0,'参展证B',2,printstatus,1,verificationstatus,cardnature,'');
			}
			table.render({
				elem : '#test',
				url : '/manage/Exhibitors/ebsPersonnelcard/Personnelcardproductionlist',
				where : {
					status : 1,
					printstatus : $("input[name='printstatus']:checked").val(),
					cardnature : $("input[name='cardnature']:checked").val(),
					verificationstatus : $("input[name='verificationstatus']:checked").val(),
					cardtype : $("input[name='cardtype']:checked").val(),
					isexhibitor : 0
				},
				response : {
					statusCode : 1
				},
				
				page : true,
				cols : [[//表头
				{
					type : 'checkbox'
				}, {
					type : 'numbers',
					title : '序号'
				}, {
					align : 'center',
					field : 'agentname',
					title : '代办员'
				}, {
					align : 'center',
					field : 'middleid',
					title : '企业Id'
				}, {
					align : 'center',
					field : 'companyname',
					title : '公司名称'
				}, {
					align : 'center',
					field : 'cardtypename',
					title : '证件类型'
				},
				/*{
				 align : 'center',
				 field : 'tjleixing',
				 title : '添加类型'
				 }, */
				{
					align : 'center',
					field : 'name',
					title : '姓名',
					templet : function(d) {
						return getUrlName(d.name);
					}
				}, {
					align : 'center',
					field : 'name',
					title : '证件照',
					templet : function(d) {
						return getImg(d.imagepath);
					}
				}, {
					align : 'center',
					field : 'printstatusname',
					title : '打印状态 ',
					width : 80
				}, {
					align : 'center',
					field : 'printtypename',
					title : '打印类型',
					width : 80
				}, {
					fixed : 'right',
					field : 'status',
					title : '操作',
					toolbar: '#barDemo',
					width : 140
				}]],
				done : function(res, curr, count) {// 表格渲染完成之后的回调
					userPermissions.forEach(function (item, index) {
						//完成到未打印
		        		if (item == 'Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdateBack'){		        		
		        			$('.huiche').removeClass("layui-hide");
		        		}
		        		//未打印到完成
		        		if (item == 'Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdate_WtoY'){		        		
		        			$('.wToy').removeClass("layui-hide");
		        		}
		        		//打印中到未打印
		        		if (item == 'Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdateBack_ZtoW'){		        		
		        			$('.zTow').removeClass("layui-hide");
		        		}
		        		//打印中到完成
		        		if (item == 'Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdateBack_ZtoY'){		        		
		        			$('.zToy').removeClass("layui-hide");
		        		}
		      		});
				}
			});
			//监听工具条
			table.on('tool(test)', function(obj) {
				var data = obj.data;
				if (obj.event === 'detail') {
					sessionStorage.setItem("viewPersonnelCardProductionId", data.id);
					xadmin.open('人员证件详情', 'PersonnelCardProductionView.html');
				} else if (obj.event === 'wToy') {
					//未打印=>完成打印
					layer.confirm('确认要变更为完成打印吗？', function() {
						updatePrintStatusback(data.id,2,1);
						//loadShuliang();
						layer.msg('设置成功', {
						icon : 1,
						time : 1000
						});
						setTimeout(function() {
							reloadTableDataCurrent();
						}, 1000);
					});
				} else if (obj.event === 'zTow') {
					//打印中=>未打印
					layer.confirm('确认要回撤到未打印吗？', function() {
						updatePrintStatusback(data.id,0,2);
						//loadShuliang();
						layer.msg('回撤成功', {
						icon : 1,
						time : 1000
						});
						setTimeout(function() {
							reloadTableDataCurrent();
						}, 1000);
					});
				} else if (obj.event === 'zToy') {
					//打印中=>完成打印
					layer.confirm('确认要变更为完成打印吗？', function() {
						updatePrintStatusback(data.id,2,3);
						//loadShuliang();
						layer.msg('设置成功', {
						icon : 1,
						time : 1000
						});
						setTimeout(function() {
							reloadTableDataCurrent();
						}, 1000);
					});
				} else if (obj.event === 'print') {
					//正常打印
					updatePrintStatus(data.id,1);
					//loadShuliang();
					sessionStorage.setItem("cardtypename", data.cardtypename);
					sessionStorage.setItem("viewEbsPersonnelcardId", data.id);
					xadmin.open('打印', 'PersonnelCardProductionPrint.html');
				} else if (obj.event === 'backprint'){
					//完成打印=>未打印
					layer.confirm('确认要回撤到未打印吗？', function() {
						updatePrintStatusback(data.id,0,0);
						//loadShuliang();
						layer.msg('回撤成功', {
						icon : 1,
						time : 1000
						});
						setTimeout(function() {
							reloadTableDataCurrent();
						}, 1000);
					});
				}
			});
		});
		
		function loadShuliang(){
			$("#txtsearchtype").val("");
			GetAgentCertificateReview(form, 'agent', 2);
			GetDocumentsToBePrinted(form, 'jiabinB', 0, '嘉宾证B');
			GetDocumentsToBePrinted(form, 'buchezhan', 0, '布撤展证');
			GetDocumentsToBePrinted(form, 'caigoushang', 0, '采购商证');
			GetDocumentsToBePrinted(form, 'canzhanzhengB', 0, '参展证B');
		}

		function ChuLiSelect(inputid) {
			$(".xlselect").each(function() {
				if ($(this).attr("id") != inputid) {
					$(this).val('');
				}
			});
			$("#txtvalue").val($("#" + inputid).val());
			$("#txtsearchtype").val(inputid);
			if($("#"+inputid).val()==''){
				$("#txtsearchtype").val('');
			}
		}

		//重新加载数据
		function reloadTableData() {
			var where = {};
			var agent = "";
			var cardtype = "";
			var companyname = "";				
			var searchType = $("#txtsearchtype").val();
			if(searchType=='agent'){//选择代办员时
				where={
					agent : $("#agent").val(),
					cardtype : $("input[name='cardtype']:checked").val(),
					companyname : $("#companyname").val(),
					status:1,
					printstatus : $("input[name='printstatus']:checked").val(),				
					name : $("#xingming").val(),
					isexhibitor:0,
				};
			}	
			else if(searchType==''){
				var jyt = '';
				if($("input[name='cardtype']:checked").val()!='') jyt="yes";
				where={
				agent:'',
				cardtype : $("input[name='cardtype']:checked").val(),
				companyname : $("#companyname").val(),
				status:1,
				printstatus : $("input[name='printstatus']:checked").val(),				
				name : $("#xingming").val(),
				isexhibitor:0,
				jyt:jyt
				};
			}else {
				var val = $("#"+searchType).val();	
				if(typeof(val) != "undefined"){		
					if(val != ''){
						var strArgs = val.split('|');
						companyname = strArgs[0];
						cardtype = strArgs[1];
						where={
							agent:strArgs[2],
							//companyname : strArgs[0],
							cardtype : strArgs[1],
							status:1,
							printstatus : $("input[name='printstatus']:checked").val(),				
							name : $("#xingming").val(),
							isexhibitor:0,
						};
					}
				}
			}
			console.log(where);
			table.reload('test', {
				method : 'get',
				page : {
					curr : 1
				},
				url : '/manage/Exhibitors/ebsPersonnelcard/Personnelcardproductionlist',
				where : where/*{
					status : 1,
					printstatus : $("input[name='printstatus']:checked").val(),
					cardnature : $("input[name='cardnature']:checked").val(),
					companyname : companyname,
					name : $("#keywordname").val(),
					verificationstatus : $("input[name='verificationstatus']:checked").val(),
					cardtype : cardtype,
					isexhibitor : 0,
					agent : agent
				}*/
			});
		}

		function reloadTableDataCurrent() {
			//loadShuliang();
			var where = {};
			var agent = "";
			var cardtype = "";
			var companyname = "";				
			var searchType = $("#txtsearchtype").val();
			if(searchType=='agent'){//选择代办员时
				where={
					agent : $("#agent").val(),
					cardtype : $("input[name='cardtype']:checked").val(),
					companyname : $("#companyname").val(),
					status:1,
					printstatus : $("input[name='printstatus']:checked").val(),				
					name : $("#xingming").val(),
					isexhibitor:0,
				};
			}	
			else if(searchType==''){
				var jyt = '';
				if($("input[name='cardtype']:checked").val()!='') jyt="yes";
				where={
				agent:'',
				cardtype : $("input[name='cardtype']:checked").val(),
				companyname : $("#companyname").val(),
				status:1,
				printstatus : $("input[name='printstatus']:checked").val(),				
				name : $("#xingming").val(),
				isexhibitor:0,
				jyt:jyt
				};
			}else {
				var val = $("#"+searchType).val();	
				if(typeof(val) != "undefined"){		
					if(val != ''){
						var strArgs = val.split('|');
						companyname = strArgs[0];
						cardtype = strArgs[1];
						where={
							agent:strArgs[2],
							//companyname : strArgs[0],
							cardtype : strArgs[1],
							status:1,
							printstatus : $("input[name='printstatus']:checked").val(),				
							name : $("#xingming").val(),
							isexhibitor:0,
						};
					}
				}
			}
			//console.log(where);
			table.reload('test', {
				method : 'get',
				url : '/manage/Exhibitors/ebsPersonnelcard/Personnelcardproductionlist',
				where : where /*{
					status : 1,
					printstatus : $("input[name='printstatus']:checked").val(),
					cardnature : $("input[name='cardnature']:checked").val(),
					companyname : companyname,
					name : $("#keywordname").val(),
					verificationstatus : $("input[name='verificationstatus']:checked").val(),
					cardtype : cardtype,
					isexhibitor : 0,
					agent : agent
				}*/
			});
		}

		function updatePrintStatus(id, printstatus) {
			var params = {};
			params.id = id;
			params.printstatus = printstatus;
			$.ajax({
				url : "/manage/Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdate",
				data : JSON.stringify(params),
				type : "post",
				async:false,
				contentType : "application/json",
				success : function(result) {
					/*layer.msg('更新成功', {
						icon : 1,
						time : 1000
					});*/
					setTimeout(function() {
						//reloadTableDataCurrent();
					}, 1000);
				}
			});
		}
		
		function updatePrintStatusback(id, printstatus, type) {
			var url = '';
			switch(type){
				case 0://完成到未打印
					url="/manage/Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdateBack";
				break;
				case 1://未打印到完成
					url="/manage/Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdate_WtoY";
				break;
				case 2://打印中到未
					url="/manage/Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdateBack_ZtoW";
				break;
				case 3://打印中到完成
					url="/manage/Exhibitors/ebsPersonnelcard/ExhibitorbadgeprintingUpdateBack_ZtoY";
				break;
			}
			var params = {};
			params.id = id;
			params.printstatus = printstatus;
			$.ajax({
				url : url,
				data : JSON.stringify(params),
				type : "post",
				async:false,
				contentType : "application/json",
				success : function(result) {
					/*layer.msg('更新成功', {
						icon : 1,
						time : 1000
					});*/
					setTimeout(function() {
						reloadTableDataCurrent();
					}, 1000);
				}
			});
		}
		
		function PrintAll() {
			var checkStatus = table.checkStatus('test');
			var ids = [];
			if (checkStatus.data.length == 0) {
				layer.msg('请先选择要打印的行', {
					icon : 5
				});
				return;
			} else {
				checkStatus.data.forEach(function(item, index, dataList) {
					ids.push(item.id);
				});
			}
			var loading = layer.load(0, {
				shade : false,
				//time: 2*1000
			});
			var selectCount = checkStatus.data.length;
			var isStr = "";
			var ids = "";
			for (var i = 0; i < selectCount; i++) {
				isStr = isStr + "," + checkStatus.data[i].id;
				updatePrintStatus(checkStatus.data[i].id,1);
				if (i == 0) {
					ids = checkStatus.data[i].id;
				} else {
					ids = ids + "," + checkStatus.data[i].id;
				}
			}		
			$("#txtids").val(ids);
			reloadTableDataCurrent();
			$.ajax({
				url : "/manage/Exhibitors/ebsPersonnelcard/printAll",
				data : {
					isStr : isStr,
					leixing : 'person'
				},
				dataType : "json",
				type : "post",
				async:false,
				success : function(result) {
					if (result.code === 1) {
						
						var html = "";
						for (var j = 0; j < result.data.length; j++) {
							//$("#txttmep").append(result.data[j].temp);
							//$("#txttmep").append("LODOP.NewPage();");
							html += result.data[j].temp + "LODOP.NewPage();";
						}
						//document.getElementById('txttmep').value=html;

						MyData = "";
						//打印前变量重读一下最新值
						LODOP = getLodop();
						eval(html);
						if (LODOP.CVERSION)
							CLODOP.On_Return = function(TaskID, Value) {
								if (Value == 1) {									
									var ido = $("#txtids").val();
									var id = ido.split(',');
									updatePersonStatusALL(ido);
									layer.msg("打印完成", {
										icon : 6,
										time : 500
									}, function() {
										reloadTableDataCurrent();
									});
								}
							};
						LODOP.PREVIEW();
						layer.close(loading);
					} else {
						layer.alert(result.msg, {
							icon : 5
						});
					}
				}
			});

		}

	</script>
</html>