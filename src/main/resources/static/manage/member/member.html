<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>会员管理</title>
<link rel="shortcut icon" href="/favicon.ico">
<link href="../css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
<link href="../css/font-awesome.css?v=4.4.0" rel="stylesheet">
<link href="../css/animate.css" rel="stylesheet">
<link href="../css/style.css?v=4.1.0" rel="stylesheet">
<link href="../css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
<link rel="stylesheet" href="../js/plugins/layui/css/layui.css"  media="all">
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content  animated fadeInRight">
  <div class="row">
    <div class="col-sm-12">
      <div class="ibox float-e-margins">
        <div class="ibox-title">
          <h5 id="ibox-title">会员管理</h5>
          <div class="ibox-tools"> <a class="collapse-link"> <i class="fa fa-chevron-up"></i> </a> <a class="close-link"> <i class="fa fa-times"></i> </a> </div>
        </div>        
        <div class="ibox-content">
            <div class="fixed-table-toolbar" style="height:50px;">
              <div class="bars pull-left">
                <div class="btn-group hidden-xs" id="exampleTableEventsToolbar" role="group">
                  <button type="button" class="btn btn-outline btn-default" title="新建研究者" id="addMember"> <i class="glyphicon glyphicon-plus" aria-hidden="true"></i> </button>
                  <button type="button" class="btn btn-outline btn-default" title="批量删除" id="delAll"> <i class="glyphicon glyphicon-trash" aria-hidden="true"></i> </button>
                </div>
              </div>
              <div class="columns columns-right btn-group pull-right">
                <button class="btn btn-default btn-outline" type="button" name="search" title="搜索" id="search"> <i class="glyphicon glyphicon-search"></i> </button>
                <button class="btn btn-default btn-outline" type="button" name="refresh" title="刷新" id="refresh"> <i class="glyphicon glyphicon-repeat"></i> </button>
              </div>
              <div class="pull-right search">
                <input name="keyword" class="form-control input-outline" type="text" placeholder="请输会员姓名" id="keyword">
              </div>
            </div>
          <table id="list" lay-filter="test">
          </table>
        </div>
      </div>
    </div>    
  </div>
</div>
<div class="modal inmodal" id="user-model">
	<div class="modal-content animated bounceInUp">
      <div class="ibox-title">
        <h5 id="edit-title">新增研究者</h5>
        <div class="ibox-tools"><a class="close-link" data-dismiss="modal"> <i class="fa fa-times"></i> </a> </div>
      </div>
      <div class="ibox-content">
        <fieldset class="layui-elem-field layui-field-title">
          <form class="layui-form layui-form-pane" action="">
          <input type="hidden" name="memberId" id="memberId" value="0" />
		<div class="layui-form-item">
          <label class="layui-form-label">用户名</label>
          <div class="layui-input-block">
				<input type="text" value="" placeholder="职工号" class="layui-input"  lay-verify="required" name="memberUsername" id="memberUsername" />
          </div>
        </div>
		<div class="layui-form-item">
			<div class="layui-inline">
	          <label class="layui-form-label">密码</label>
	          <div class="layui-input-inline">
					<input type="password" value="" lay-verify="required" name="memberPassword" id="memberPassword"  class="layui-input"/>
					
	          </div>
	        </div>
			<div class="layui-inline" style="display:none"><button class="layui-btn" id="password" data-toggle="modal" data-target="#myModal">修改密码</button></div>
        </div>
		<div class="layui-form-item">
          <label class="layui-form-label">性别</label>
          <div class="layui-input-block">
				<select class="form-control reg-sel" name="memberSex" id="memberSex" lay-verify="required">
					<option value="1">男</option>
					<option value="0">女</option>
				</select>
          </div>
        </div>
		<div class="layui-form-item">
          <label class="layui-form-label">单位</label>
          <div class="layui-input-block">
          	<input type="text" value="" placeholder="单位" class="layui-input"  lay-verify="required" name="memberCompany" id="memberCompany" />
          </div>
        </div>
		<div class="layui-form-item">
          <label class="layui-form-label">会员类型</label>
          <div class="layui-input-block">
				<select class="form-control reg-sel" name="memberEnum" id="memberEnum" lay-verify="required">
					<option value="员工">员工</option>
					<option value="学生">学生</option>
				</select>
          </div>
        </div>
		<div class="layui-form-item">
          <label class="layui-form-label">地址</label>
          <div class="layui-input-block">
				<input type="text" value="" placeholder="地址" class="layui-input" name="memberTitle" id="memberTitle" lay-verify="required"/>
          </div>
        </div>
		<div class="layui-form-item">
          <label class="layui-form-label">邮编</label>
          <div class="layui-input-block">
				<input type="text" value="" placeholder="邮编" class="layui-input" name="memberPost" id="memberPost" lay-verify="required"/>
          </div>
        </div>
		<div class="layui-form-item">
          <label class="layui-form-label">手机号</label>
          <div class="layui-input-block">
				<input type="text" value="" placeholder="手机号" class="layui-input" name="memberPhone" id="memberPhone" lay-verify="required|phone"/>
          </div>
        </div>
		<div class="layui-form-item" style="display:none">
          <label class="layui-form-label">座机号</label>
          <div class="layui-input-block">
				<input type="text" value="" placeholder="座机号" class="layui-input" name="memberTel" id="memberTel" lay-verify=""/>
          </div>
        </div>
		<div class="layui-form-item">
          <label class="layui-form-label">邮箱</label>
          <div class="layui-input-block">
				<input type="text" value="" placeholder="邮箱" class="layui-input" name="memberEmail" id="memberEmail" lay-verify="required|email"/>
          </div>
        </div>	
            <div class="layui-form-item">
              <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="demo1">保存</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
              </div>
            </div>
          </form>
        </fieldset>
      </div>
      </div>
 </div>
<!-- 全局js --> 
<script src="../js/plugins/layui/layui.all.js" charset="utf-8"></script> 
<script src="../js/jquery.min.js?v=2.1.4"></script> 
<script src="../js/bootstrap.min.js?v=3.3.6"></script> 
<script src="../plugins/ckeditor/ckeditor.js" charset="utf-8"></script>

<!-- 自定义js --> 
<script src="../js/content.js?v=1.0.0"></script> 
<script src="../js/W.js?v=3.3.6"></script> 
<script>
	var cid,projectType;
	var table = layui.table;

		var functionList;
        $(document).ready(function () {
			menuName = $.trim($(".page-tabs-content",window.parent.document).children(".active").text());
			cid = $(".page-tabs-content",window.parent.document).children(".active").data("cid");
			$("#ibox-title").text(menuName+'管理');
			//var projectLoading = layer.load(1, {shade:0.8});
			/* $.post('/manage/system/getUnits',{page:1,limit:1000,field:"dicOrder",order:"ASC",keywords:""},
				function(data){
					layer.close(projectLoading);
					if(data.status==1){
						projectType = data.result;
						$("#memberCompany").append("<option value=''>请选择</option>");
						for(var t in projectType){
							$("#memberCompany").append("<option value='"+projectType[t].dicCode+"'>"+projectType[t].dicName+"</option>");
						}
					}
					else if(data.status==5){
						window.location.href="/login.html";
					}
					else{
						layer.msg(data.msg, {icon: 6});
					}
				}); */
			renderTable();
		 });	
 	function renderTable(){
		//执行渲染
		table.render({
		  even:true//隔行背景
		  ,elem: '#list' //指定原始表格元素选择器（推荐id选择器）
		  ,height: 'full-220' //容器高度
		  ,cols: [[{checkbox: true}
    			,{field: 'memberId', title: 'ID',sort:false,width:100}
    			,{field: 'memberUsername', title: '会员名',sort:true,width:100}
    			//,{field: 'memberName', title: '姓名',sort:true,width:100}
    			//,{field: 'memberSex', title: '性别',sort:true,width:100,templet:'#sexTpl'}
    			,{field: 'memberEnum', title: '会员类型',sort:true,width:100}
    			,{field: 'memberEmail', title: '注册邮箱',sort:true,width:300}
    			,{field: 'memberPhone', title: '手机',sort:true,width:150}
    			,{field: 'memberCompany', title: '单位',sort:true,width:100}
    			,{field: 'memberRegistDate', title: '注册时间',sort:true,width:200,templet:'<div>{{(new Date(d.memberRegistDate)).toLocaleString()}}</div>'}
    			,{field: 'memberStatus', title: '状态',sort:true,width:140,templet:'#statusTpl'}
				,{fixed: 'right', width:200, align:'center', toolbar: '#toolBar',title:'操作'} //这里的toolbar值是模板元素的选择器

				]] //设置表头
			  ,url: '/manage/member/getMembers'
			  ,where: {
				  keywords:$("#keyword").val(),
				  field:'memberRegistDate',
				  order:'DESC'
			  }
			  ,method: 'post' //如果无需自定义HTTP类型，可不加该参数
			  //request: {} //如果无需自定义请求参数，可不加该参数
			  ,response: {			  
				  statusName: 'status' //数据状态的字段名称，默认：code
				  ,statusCode: 1 //成功的状态码，默认：0
				  ,dataName: 'result' //数据列表的字段名称，默认：data			  
				  } //如果无需自定义数据响应名称，可不加该参数
			  ,page:true
			  ,limits:[10,20,30,40,50,60,70,80,90,100]
			  ,limit:10
			  ,loading:true
			  ,id:'id'
				  //,…… //更多参数参考右侧目录：基本参数选项
		});
		//监听工具条
		table.on('tool(test)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
		  var data = obj.data; //获得当前行数据
		  var layEvent = obj.event; //获得 lay-event 对应的值
		  var tr = obj.tr; //获得当前行 tr 的DOM对象
		 
		  if(layEvent === 'del'){ //删除
		  	deleteMembers(obj);
		  } else if(layEvent === 'edit'){ //编辑
			openEditMember(obj);
		  }else if(layEvent === 'active'){ //编辑
			openActiveUI(obj);
		  }
		});
		table.on('sort(test)', function(obj){ //注：sort是排序事件名，test是table原始容器的属性 lay-filter="对应的值"
		  console.log(obj.field); //当前排序的字段名
		  console.log(obj.type); //当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
		  console.log(this); //当前排序的 th 对象
		  
		  //尽管我们的 table 自带排序功能，但并没有请求服务端。
		  //有些时候，你可能需要根据当前排序的字段，重新向服务端发送请求，如：
		  table.reload('id', {
			initSort: obj //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
			,where: { //请求参数
			  field: obj.field //排序字段
			  ,order: obj.type //排序方式
			}
		  });
		});
 	}
		//重新加载数据
		function reloadTableData(){
			table.reload('id',{
			  method:'post'
			  ,url: '/manage/member/getMembers'
			  ,where: {
				  keywords:$("#keyword").val(),
				  field:'memberRegistDate',
				  order:'desc'
				  }			  
			});
		}
		var form;
		layui.use(['form'], function(){
		  form = layui.form;		 
		  //自定义验证规则
		  form.verify({
			title: function(value){
			  if(value.length < 2){
				return '标题至少得2个字符啊';
			  }
			},
			MemberFile:function(value){
				if(value.length>100){
					return '简介内容不可超过100个字';
				}
			}
		  });
  
		  //监听提交
		  form.on('submit(demo1)', function(data){
			  	var url = "/manage/member/updateMember";
				displayLoading(true);
				$.post(url,data.field,
				function(data){
					if(data.status==1){						
						layer.msg('保存成功', {icon: 6});
						$("#user-model").modal('hide');
						reloadTableData();
					}
					else if(data.status==4){
						window.location.href="/manage/nopermission.html";
					}
					else if(data.status==5){
						layer.confirm(data.msg, {icon: 3, title:'提示'}, function(index){
							  window.location.href="/manage/login.html";
							  layer.close(index);
							});
					}
					else{
						layer.msg(data.msg, {icon: 6});
					}
					hiddenLoading(true);
				});
			return false;
		  });  
		});
		function openAddMember(){
			$("#edit-title").text('新增'+menuName);
			$(":reset").click();//重置所有表单元素
			$("#memberUsername").attr("disabled",false);
			$("input[name='MemberId']").val(0);
			$("#user-model").modal({
				keyboard: true
			});
		}
		function openEditMember(obj){
			$("#edit-title").text('编辑'+menuName);
			$("#memberUsername").attr("disabled",true);
			for(var key in obj.data){
				if(key=="memberEnum"){
					$("#"+key).find("option[value='"+obj.data[key]+"']").attr("selected",true);
				}
				else if(key =="memberSex"){
					sexIndex = obj.data[key]?1:0;
					$("#"+key).find("option[value='"+sexIndex+"']").attr("selected",true);
				}
				else{
					$("#"+key).val(obj.data[key]);
				}
			}
			form.render('select');
			$("#user-model").modal({
				keyboard: true
			});
		}
		function openActiveUI(obj){
			var windowsIndex = layer.open({
				  title: '请选择会员类型'
				  ,content: '<input type="radio" value="员工" name="mType"> 员工<br /><input type="radio" value="学生" name="mType"> 学生'
				  ,yes:function(index,layero){
					  var mType = $("input[name=mType]:checked").val();
					  if(mType==undefined){
						  alert("请选择会员类型");
					  }
					  else{
						  displayLoading(true);
						  $.post("/manage/member/updateMember",{
									  memberId:obj.data.memberId,
									  memberEnum:mType,
									  memberStatus:1,
									  memberActivationDate:getNowFormatDate()
								  },
								  function(data){
									hiddenLoading(true);
									if(data.status==1){						
										//先更新本地数据
										layer.msg('激活成功', {icon: 6});
									}
									else if(data.status==4){
										window.location.href="/manage/nopermission.html";
									}
									else if(data.status==5){
										layer.confirm(data.msg, {icon: 3, title:'提示'}, function(index){
											  window.location.href="/manage/login.html";
											  layer.close(index);
											});
									}
									else{
										layer.msg(data.msg, {icon: 6});
									}
									reloadTableData();
							  });
					  }
				  }
				}); 
		}
		function deleteMembers(obj){		
			layer.confirm('确认要删除此数据吗？', function(index){
				layer.close(index);
				var MemberIdList = new Array();
				if(obj){//删除单行
					MemberIdList.push(obj.data.memberId);
				}
				else{//删除选中行
					var checkStatus = table.checkStatus('id');
					if(checkStatus.data.length==0){
						layer.msg('请先选择要删除的行',{icon:5});
						return;
					}
					else{
						checkStatus.data.forEach(function(item,index,dataList){
							MemberIdList.push(item.memberId);
						});
					}
				}
				displayLoading(true);
				$.post("/manage/member/delete",{idList:MemberIdList},
					function(data){
						if(data.status==1){						
							//先更新本地数据
							layer.msg('删除成功', {icon: 6});
						}
						else if(data.status==4){
							window.location.href="/manage/nopermission.html";
						}
						else if(data.status==5){
							layer.confirm(data.msg, {icon: 3, title:'提示'}, function(index){
								  window.location.href="/manage/login.html";
								  layer.close(index);
								});
						}
						else{
							layer.msg(data.msg, {icon: 6});
						}
						hiddenLoading(true);
						$("#user-model").modal('hide');
						reloadTableData();
				});
			});			
		}
		$("#addMember").on('click',openAddMember);
		$("#refresh,#search").on("click",reloadTableData);
		$("#delAll").on('click',function(){deleteMembers()});
		function getNowFormatDate() {
		    var date = new Date();
		    var seperator1 = "-";
		    var seperator2 = ":";
		    var month = date.getMonth() + 1;
		    var strDate = date.getDate();
		    if (month >= 1 && month <= 9) {
		        month = "0" + month;
		    }
		    if (strDate >= 0 && strDate <= 9) {
		        strDate = "0" + strDate;
		    }
		    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
		            + " " + date.getHours() + seperator2 + date.getMinutes()
		            + seperator2 + date.getSeconds();
		    return currentdate;
		}
    </script> 
	<script type="text/html" id="toolBar">
	{{# if(!d.memberStatus){ }}
	  <a class="layui-btn layui-btn-mini" lay-event="active">激活</a>
	{{# } }}
	  <a class="layui-btn layui-btn-mini" lay-event="edit">编辑</a>
	  <a class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del">删除</a>
	</script>
    <script type="text/html" id="statusTpl">
	  {{#  if(d.memberStatus){ }}
		正常
	  {{#  } else { }}
		待激活
	  {{#  } }}
	</script>
</body>
</html>
